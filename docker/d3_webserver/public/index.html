<!DOCTYPE html>
<meta charset="utf-8">
<html>
 <head>
  <script src="http://d3js.org/d3.v3.min.js"></script>
  <script src="./scripts/d3sparql.js"></script>
  <link rel="stylesheet" type="text/css" href="styles.css">
  <script>
    function loadGenres() {
      var endpoint = d3.select("#endpoint").property("value");
      var genreQuery = document.getElementById("genre-query").textContent;

      d3sparql.query(endpoint, genreQuery, function(json) {
        var select = d3.select("#genre-selection");
        json.results.bindings.forEach(function(binding) {
          select.append("option").attr("value", binding.genre_name.value).text(binding.genre_name.value);
        });
      });
    }

    function searchArtists() {
      var endpoint = d3.select("#endpoint").property("value");
      var input = d3.select("#artist-search").property("value");

      if (input.length < 1) { // Start search only after 3 characters have been typed.
        return;
      }

      var searchQuery = `
        PREFIX : <http://localhost:3333/>
        PREFIX xsd: <http://www.w3.org/2001/XMLSchema#>
        PREFIX sch: <https://schema.org/>

        SELECT ?artist_name
        WHERE {
          ?artist a sch:MusicGroup;
                  :name ?artist_name.
          FILTER(STRSTARTS(LCASE(?artist_name), LCASE("${input}")))
        }
        ORDER BY ?artist_name
        LIMIT 5
      `;

      d3sparql.query(endpoint, searchQuery, updateArtistSuggestions);
    }

    function updateArtistSuggestions(json) {
      var list = d3.select("#artist-suggestions");
      list.html(""); // Clear existing suggestions.

      json.results.bindings.forEach(function(binding) {
        list.append("option").attr("value", binding.artist_name.value);
      });
    }

    function setArtistName(name) {
      document.getElementById('artist-search').value = name;
      document.getElementById('artist-suggestions').innerHTML = '';
    }

    window.onload = exec();

    function exec() {
      /* Uncomment to see debug information in console */
      d3sparql.debug = true
      var endpoint = d3.select("#endpoint").property("value")

      loadGenres()

      var sparql_album_release_over_year = d3.select("#album-release-over-year").property("value")
      d3sparql.query(endpoint, sparql_album_release_over_year, render_album_release_over_year)

      var sparql_most_popular_genre = d3.select("#most-popular-genre").property("value")
      d3sparql.query(endpoint, sparql_most_popular_genre, render_most_popular_genre)

      //var sparql_age_first_album_release = d3.select("#age-first-album-release").property("value")
      //d3sparql.query(endpoint, sparql_age_first_album_release, render_age_first_album_release)
    }

    function render_album_release_over_year(json) {
      var config = {
        "selector": "#result_album_release_over_year",
        //"width": 800,  // Adjust the width as needed
        //"height": 400, // Adjust the height as needed
        //"margin": {top: 40, right: 20, bottom: 30, left: 40},
        "xaxis": "releaseYear",
        "yaxis": "numberOfAlbums",
        "var_x": "releaseYear",
        "var_y": "numberOfAlbums"
      }
      d3sparql.barchart(json, config)
    }

    function render_most_popular_genre(json) {
      var config = {
        "selector": "#result_most_popular_genre",
        //"width": 800,  // Adjust the width as needed
        //"height": 400, // Adjust the height as needed
        //"margin": {top: 40, right: 20, bottom: 30, left: 40},
        "xaxis": "genre_name",
        "yaxis": "count",
        "var_x": "genre_name",
        "var_y": "count"
      }
      d3sparql.barchart(json, config)
    }

    // function render_age_first_album_release(json) {
    //   var config = {
    //     "selector": "#age_first_album_release",
    //     //"width": 800,  // Adjust the width as needed
    //     //"height": 400, // Adjust the height as needed
    //     //"margin": {top: 40, right: 20, bottom: 30, left: 40},
    //     "xaxis": "age",
    //     "yaxis": "count",
    //     "var_x": "age",
    //     "var_y": "count"
    //   }
    //   d3sparql.barchart(json, config)
    // }

    function exec_danceability_speach_by_genre() {
      d3sparql.debug = true
      var endpoint = d3.select("#endpoint").property("value")

      function render_danceability_by_genre(json) {
        var config = {
        "selector": "#danceability_by_genre",
          //"width": 800,  // Adjust the width as needed
          //"height": 400, // Adjust the height as needed
          //"margin": {top: 40, right: 20, bottom: 30, left: 40},
          "xaxis": "genre_name",
          "yaxis": "avg_speach",
          "var_x": "genre_name",
          "var_y": "avg_speach"
        }
        d3sparql.barchart(json, config)
      }

      var selectedOptions = d3.select("#genre-selection").property("selectedOptions");
      var genres = Array.from(selectedOptions).map(option => `"${option.value}"`);
      var genreFilter = genres.length > 0 ? "FILTER (?genre_name IN (" + genres.join(",") + "))" : "";
      var queryTemplate = document.getElementById("danceability-speach-by-genre").textContent;
      var query = queryTemplate.replace("{{GENRE_FILTER}}", genreFilter);

      d3sparql.query(endpoint, query, render_danceability_by_genre);

      function render_speach_by_genre(json) {
        var config = {
          "selector": "#speach_by_genre",
            //"width": 800,  // Adjust the width as needed
            //"height": 400, // Adjust the height as needed
            //"margin": {top: 40, right: 20, bottom: 30, left: 40},
            "xaxis": "genre_name",
            "yaxis": "avg_speach",
            "var_x": "genre_name",
            "var_y": "avg_speach"
          }
          d3sparql.barchart(json, config)
        }

        var selectedOptions = d3.select("#genre-selection").property("selectedOptions");
        var genres = Array.from(selectedOptions).map(option => `"${option.value}"`);
        var genreFilter = genres.length > 0 ? "FILTER (?genre_name IN (" + genres.join(",") + "))" : "";
        var queryTemplate = document.getElementById("danceability-speach-by-genre").textContent;
        var query = queryTemplate.replace("{{GENRE_FILTER}}", genreFilter);

        d3sparql.query(endpoint, query, render_speach_by_genre);
    }

    function render_artist_popularity_over_year(json) {
        var config = {
        "selector": "#artist_popularity_over_year",
          //"width": 800,  // Adjust the width as needed
          //"height": 400, // Adjust the height as needed
          //"margin": {top: 40, right: 20, bottom: 30, left: 40},
          "xaxis": "release_year",
          "yaxis": "avg_popularity",
          "var_x": "release_year",
          "var_y": "avg_popularity"
        }
        d3sparql.barchart(json, config)
      }

    function exec_artist_popularity_over_year() {
      d3sparql.debug = true;
      var endpoint = d3.select("#endpoint").property("value");
      var artistName = document.getElementById('artist-search').value;
      console.log(artistName)
      var artistFilter = "FILTER (?artist_name = " + artistName + ")";
      var queryTemplate = document.getElementById("artist-popularity-over-year").textContent;
      var query = queryTemplate.replace("{{ARTIST_FILTER}}", artistFilter);

      d3sparql.query(endpoint, query, render_artist_popularity_over_year);
    }
    
  </script>
  <style></style>
  </head>
  <body onload=exec()>
    <form style="display:none">
    <input id="endpoint" value="http://localhost:3030/spotify_songs" type="text">

    <textarea id="genre-query">
      PREFIX : <http://localhost:3333/>
      PREFIX xsd: <http://www.w3.org/2001/XMLSchema#>
      PREFIX sch: <https://schema.org/>

      SELECT ?genre_name
      WHERE {
        ?genre a sch:Genre;
          sch:headline ?genre_name.
      }
    </textarea>

    <textarea id="artist-query">
      PREFIX : <http://localhost:3333/>
      PREFIX xsd: <http://www.w3.org/2001/XMLSchema#>
      PREFIX sch: <https://schema.org/>

      SELECT ?artist_name
      WHERE {
        ?artist a sch:MusicGroup;
        :name ?artist_name.
      }
      order by ?artist_name
    </textarea>

    <textarea id="album-release-over-year" style="display: none;">
      PREFIX : <http://localhost:3333/>
      PREFIX sch: <https://schema.org/>

      SELECT ?releaseYear (COUNT(?album) AS ?numberOfAlbums)
      WHERE {
        ?album a sch:MusicAlbum;
              :releaseYear ?releaseYear .
      }
      GROUP BY ?releaseYear
      ORDER BY ?releaseYear
    </textarea>

    <textarea id="most-popular-genre">
      PREFIX sch: <https://schema.org/>

      SELECT ?genre_name (COUNT(?track) AS ?count)
      WHERE {
        ?track a sch:MusicRecording;
          sch:genre ?genre .
        ?genre a sch:Genre ;
          sch:headline ?genre_name .
      }
      GROUP BY ?genre_name  
      ORDER BY DESC(?count)
    </textarea>
    
    <textarea id="danceability-speach-by-genre">
      PREFIX : <http://localhost:3333/>
      PREFIX xsd: <http://www.w3.org/2001/XMLSchema#>
      PREFIX sch: <https://schema.org/>

      SELECT ?genre_name (AVG(xsd:double(?has_speach)) * 100 AS ?avg_speach) (AVG(xsd:double(?is_danceable)) * 100 AS ?avg_is_danceable)
      WHERE {
        ?track a sch:MusicRecording;
          sch:genre ?genre.
        ?genre a sch:Genre;
          sch:headline ?genre_name
        OPTIONAL{?track :has_speach ?has_speach}.
        OPTIONAL{?track :is_danceable ?is_danceable}.
        {{GENRE_FILTER}}
      }
      GROUP BY ?genre_name
      ORDER BY DESC(?avg_speach)
    </textarea>

    <textarea id="artist-popularity-over-year" style="display:none;">
      PREFIX : <http://localhost:3333/>
      PREFIX xsd: <http://www.w3.org/2001/XMLSchema#>
      PREFIX sch: <https://schema.org/>

      SELECT ?release_year (AVG(xsd:integer(?popularity)) as ?avg_popularity)
      WHERE {
        ?track a sch:MusicRecording;
              sch:byArtist ?artist;
              :popularity ?popularity;
              sch:inAlbum ?album.
        ?artist a sch:MusicGroup;
              :name ?artist_name.
        ?album a sch:MusicAlbum;
              :releaseYear ?release_year.
        FILTER(?artist_name = "Lil Uzi Vert")
      }
      GROUP BY ?release_year
      ORDER BY ?release_year
    </textarea>

    <!-- The query is not working. It was 
    meant to extract the birth year of the artist to calculate the
    artist's age at the release of their first album... -->>
    <!-- <textarea id="artist-age-first-album-release">
      PREFIX sc: <http://purl.org/science/owl/sciencecommons/>
      PREFIX : <http://localhost:3030/spotify_songs/>
      PREFIX sch: <https://schema.org/>
      PREFIX dbo: <http://dbpedia.org/ontology/>
      PREFIX foaf: <http://xmlns.com/foaf/0.1/>
      PREFIX xsd: <http://www.w3.org/2001/XMLSchema#>

      SELECT ?artistName (MIN(?releaseYear) AS ?firstAlbumYear) (SAMPLE(?dob) AS ?dateOfBirth)
      WHERE {
        SERVICE <http://localhost:3030/spotify_songs/> {
          ?track a sch:MusicRecording.
            ?track sch:byArtist ?artist.
            ?track sch:inAlbum ?album.
          ?album a sch:MusicAlbum.
          OPTIONAL {?album :releaseYear ?releaseYear}.
          ?artist a sch:MusicGroup.
          OPTIONAL {?artist :name ?artistName}.
        }

        # Query DBpedia for the artist's date of birth
        SERVICE <http://dbpedia.org/sparql> {
          ?dbpediaArtist a dbo:MusicalArtist;
                          foaf:name ?artistName ;
                          dbo:birthDate ?dob .
          FILTER (datatype(?dob) = xsd:date)
        }
      }
      GROUP BY ?artistName
      ORDER BY ?artistName
    </textarea> -->
  </form>
  <h1>Spotify songs and playlists analysis</h1>
  <div>
    <p>This page is made to get a first look into 30 000 songs extracted from spotify playlists</p>
    <a href="https://www.kaggle.com/datasets/joebeachcapital/30000-spotify-songs">Here is the link to the source dataset available on Kaggle</a>
  </div>
  
  <h2>Albums first sights</h2>
  <p>Here is graph that shows the number of album release over year</p>
  <div id="result_album_release_over_year"></div>
  <p>2019 is the year with the most releases. In fact, the dataset was created in 2020.</p>
  
  <h2>Genres first sights</h2>
  <p>Here is a graph that shows the number of tracks per genre in the dataset</p>
  <div id="result_most_popular_genre"></div>
  <p>Edm, rap, r&b, pop, latin and rock are the most common genres</p>
  
  <!-- <h2>Age of the artist at their first album release</h2>
  <div id="age_first_album_release"></div> -->

  <p>You can select multiple genres to compare their average danceability and speachiness</p>
  <div>
    <select id="genre-selection" multiple size="10"></select>
    <button onclick="exec_danceability_speach_by_genre()">Run Analysis</button>
    <label for="genre-selection">Select genres</label>
  </div>
  <h4>Average danceability by genre</h4>
  <div id="danceability_by_genre"></div>
  <p>This plot shows the average danceability score of the tracks of the genres by Spotify.</p>
  <h4>Average speachiness by genre</h4>
  <div id="speach_by_genre"></div>
  <p>This plot shows the average speach score of the tracks of the genres given by Spotify.</p>

  <h2>Artist popularity over year</h2>
  <div>
    <p>You can search for your prefered artist to plot it's track popularity over the years</p>
    <label for="artist-search">Search an artist:</label>
    <input type="text" id="artist-search" oninput="searchArtists()" list="artist-suggestions" />
    <datalist id="artist-suggestions"></datalist>
    <button onclick="exec_artist_popularity_over_year()">Run Analysis</button>
  </div>
  <div id="artist_popularity_over_year"></div>
 </body>
</html>
